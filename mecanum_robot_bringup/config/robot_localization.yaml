# =============================================================================
# EKF CONFIG - NAV2 STANDARD (MECANUM ROBOT)
# =============================================================================
# MỤC ĐÍCH:
# - Fuse encoder odometry + IMU gyro
# - Sinh odometry ổn định cho Nav2
# - Publish TF: odom → base_link
#
# TRIẾT LÝ NAV2:
# - Encoder: chỉ dùng VẬN TỐC (vx, vy, wz)
# - IMU: chỉ dùng GYRO Z (wz)
# - KHÔNG fuse pose, orientation, acceleration
# =============================================================================

ekf_filter_node:
  ros__parameters:

    # =========================================================================
    # BASIC
    # =========================================================================
    use_sim_time: false
    frequency: 50.0
    sensor_timeout: 0.2
    two_d_mode: true

    publish_tf: true
    publish_acceleration: false
    odometry_output_topic: /odometry/filtered

    # =========================================================================
    # TF FRAMES (BẮT BUỘC ĐÚNG CHUẨN NAV2)
    # =========================================================================
    map_frame: map
    odom_frame: odom
    base_link_frame: base_link
    world_frame: odom

    # =========================================================================
    # INPUT 1: ENCODER ODOMETRY
    # Topic: /odom
    # DÙNG:
    # - vx, vy  (vận tốc tuyến tính)
    # - wz      (vận tốc góc - fallback)
    # =========================================================================
    odom0: /odom
    odom0_config: [false, false, false,   # x, y, z
                   false, false, false,   # roll, pitch, yaw
                   true,  true,  false,   # vx, vy, vz
                   false, false, true,    # vroll, vpitch, wz
                   false, false, false]   # ax, ay, az

    odom0_queue_size: 10
    odom0_differential: false
    odom0_relative: false

    # =========================================================================
    # INPUT 2: IMU
    # Topic: /imu/data
    # DÙNG:
    # - wz (gyro Z)
    # =========================================================================
    imu0: /imu/data
    imu0_config: [false, false, false,    # x, y, z
                  false, false, false,    # roll, pitch, yaw
                  false, false, false,    # vx, vy, vz
                  false, false, true,     # vroll, vpitch, wz
                  false, false, false]    # ax, ay, az

    imu0_queue_size: 10
    imu0_differential: false
    imu0_relative: false
    imu0_remove_gravitational_acceleration: true

    # =========================================================================
    # PROCESS NOISE (TỐI GIẢN – ỔN ĐỊNH)
    # =========================================================================
    process_noise_covariance:
      [0.05, 0,    0,    0,    0,    0,
       0,    0.05, 0,    0,    0,    0,
       0,    0,    1e6,  0,    0,    0,
       0,    0,    0,    1e6,  0,    0,
       0,    0,    0,    0,    1e6,  0,
       0,    0,    0,    0,    0,    0.1]

    # =========================================================================
    # INITIAL ESTIMATE COVARIANCE
    # =========================================================================
    initial_estimate_covariance:
      [1e-9, 0,    0,    0,    0,    0,
       0,    1e-9, 0,    0,    0,    0,
       0,    0,    1e6,  0,    0,    0,
       0,    0,    0,    1e6,  0,    0,
       0,    0,    0,    0,    1e6,  0,
       0,    0,    0,    0,    0,    1e-9]
